
每当问到VueJS响应式原理，大家可能都会脱口而出“`Vue`通过`Object.defineProperty`方法把`data`对象的全部属性转化成`getter/setter`，当属性被访问或修改时通知变化”。然而，其内部深层的响应式原理可能很多人都没有完全理解，网络上关于其响应式原理的文章质量也是参差不齐，大多是贴个代码加段注释了事。本文将会从一个非常简单的例子出发，一步一步分析响应式原理的具体实现思路。

## 使数据对象变得“可观测”

首先,我们定义一个数据对象,就以王者荣耀里面其中一个英雄为例子:

```js
const hero = {
    health: 3000,
    IQ: 150
}
```

我们定义了这个英雄的生命值为3000, IQ为150;但是我们现在不知道他是谁,不过这不重要,只需要知道这个英雄将会贯穿我们整篇文章，而我们的目的就是通过这个英雄的属性，知道这个英雄是谁。

现在我们可以通过`hero.health`和`hero.IQ`直接读取这个英雄对应的属性值,但是当这个英雄的属性被读取或者修改时,我们并不知情.那么要怎么才能让英雄主动告诉我们,他的属性被修改了呢?这个时候就需要借助`Object.defineProperty`.

关于`Object.defineProperty`,MDN上是这么说的:

> Object.defineProperty()方法会直接在一个对象上定义一个新属性,或者修改一个现有的属性,并返回这个对象.

在本文中，我们只使用这个方法使对象变得“可观测”，更多关于这个方法的具体内容，请参考[MDN](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/defineProperty)，就不再赘述了。

那么如何让这个英雄主动通知我们其属性的读写情况呢？首先改写一下上面的例子：

```js
let hero = {};
let val = 3000;

Object.defineProperty(hero, 'health', {
    get() {
        console.log('我的health属性被读取了');
        return  val;
    },
    set(newVal) {
        console.log('我的人health属性被修改了');
        val  = newVal;
    }
})

```

我们通过`Object.defineProperty`方法,给hero定义了一个health属性,这个属性会在被读写的时候触发一段`console.log`.现在来尝试一下:

```js
console.log(hero.health);

// -> 3000
// -> 我的health属性被读取了

hero.health = 5000;

// -> 我的health属性被修改了
```

可以看到,英雄已经可以主动告诉我们其属性的读写情况了,这也意味着,这个英雄的数据对象已经是"可观测"的了.为了把英雄的所有属性都变得可观测,我们一个办法:

```js
/*
* 是一个对象转换成可观测对象
* @params { Object } obj对象
* @params { String } obj对象的key
* @params { any } obj对象的某个key值
*/

function defineReactive(obj, key, value) {
    Object.defineProperty(obj, key, {
        get() {
            console.log(`我的${key}属性被读取了`);
            return val;
        },
        set(newVal) {
            console.log(`我的${key}属性被修改了`);
            val = newVal;
        }
    })
}

/**
* 把一个对象的每一项都转换成可观测对象
* @params { Object } obj对象
*/
function observable(obj) {
    const keys = Object.keys(obj);
    keys.forEach((key) => {
        defineReactive(obj, key, obj[key])
    })
    return obj;
}
```

现在我们可以把英雄这么定义:

```js
const hero = observable({
    health: 3000,
    IQ: 150
})
```

